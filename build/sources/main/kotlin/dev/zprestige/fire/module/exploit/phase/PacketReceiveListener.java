package dev.zprestige.fire.module.exploit.phase;

import dev.zprestige.fire.event.bus.EventListener;
import dev.zprestige.fire.event.impl.PacketEvent;
import net.minecraft.client.gui.GuiDownloadTerrain;
import net.minecraft.network.play.server.SPacketPlayerPosLook;
import net.minecraft.util.math.BlockPos;

public class PacketReceiveListener extends EventListener<PacketEvent.PacketReceiveEvent, Phase> {

    public PacketReceiveListener(final Phase phase) {
        super(PacketEvent.PacketReceiveEvent.class, phase);
    }

    @Override
    public void invoke(final Object object) {
        final PacketEvent.PacketReceiveEvent event = (PacketEvent.PacketReceiveEvent) object;
        if (event.getPacket() instanceof SPacketPlayerPosLook) {
            final SPacketPlayerPosLook packet = (SPacketPlayerPosLook) event.getPacket();
            final Phase.TimeVec3d posVec = module.rubberbandMap.remove(packet.getTeleportId());
            if (mc.world.isBlockLoaded(new BlockPos(mc.player.posX, mc.player.posY, mc.player.posZ), false) && !(mc.currentScreen instanceof GuiDownloadTerrain) && posVec != null && posVec.x == packet.getX() && posVec.y == packet.getY() && posVec.z == packet.getZ()) {
                event.setCancelled();
                return;
            }
            packet.yaw = mc.player.rotationYaw;
            packet.pitch = mc.player.rotationPitch;
            module.teleportId = packet.getTeleportId();
        }
    }
}
