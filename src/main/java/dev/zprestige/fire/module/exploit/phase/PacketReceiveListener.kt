package dev.zprestige.fire.module.exploit.phase

import dev.zprestige.fire.event.bus.EventListener
import dev.zprestige.fire.event.impl.PacketEvent.PacketReceiveEvent
import net.minecraft.client.gui.GuiDownloadTerrain
import net.minecraft.network.play.server.SPacketPlayerPosLook
import net.minecraft.util.math.BlockPos

class PacketReceiveListener(phase: Phase) : EventListener<PacketReceiveEvent, Phase>(
    PacketReceiveEvent::class.java, phase
) {
    override fun invoke(e: Any) {
        val event = e as PacketReceiveEvent
        if (event.packet is SPacketPlayerPosLook) {
            val packet = event.packet as SPacketPlayerPosLook
            val posVec = module.rubberbandMap.remove(packet.getTeleportId())
            if (mc.world.isBlockLoaded(BlockPos(mc.player.posX, mc.player.posY, mc.player.posZ),
                    false
                ) && mc.currentScreen !is GuiDownloadTerrain && posVec != null && posVec.x == packet.getX() && posVec.y == packet.getY() && posVec.z == packet.getZ()
            ) {
                event.setCancelled()
                return
            }
            packet.yaw = mc.player.rotationYaw
            packet.pitch = mc.player.rotationPitch
            module.teleportId = packet.getTeleportId()
        }
    }
}